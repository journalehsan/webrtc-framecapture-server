<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Janus RTP Forward Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="vendor/adapter-latest.js"></script>
    <script src="vendor/janus.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-900 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">Janus RTP Forward Demo</h1>
      
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Media Controls</h2>
        <div class="flex flex-wrap gap-3 mb-4">
          <button id="webcam" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Start Webcam</button>
          <button id="screen" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">Start Screen Share</button>
          <button id="stop" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">Stop</button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">RTP Configuration</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="rtpHost" class="block text-sm font-medium text-gray-700 mb-1">RTP Host</label>
            <input id="rtpHost" type="text" value="capture" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label for="rtpPort" class="block text-sm font-medium text-gray-700 mb-1">RTP Port</label>
            <input id="rtpPort" type="number" value="5006" min="1" max="65535" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label for="rtpPt" class="block text-sm font-medium text-gray-700 mb-1">RTP PT</label>
            <input id="rtpPt" type="number" value="96" min="0" max="127" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
          <div class="ml-3">
            <p class="text-sm text-blue-700">
              <strong>Tip:</strong> Serve this page locally for camera permissions:
              <code class="bg-blue-100 px-2 py-1 rounded text-blue-800">python3 -m http.server 8000</code>
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Local Video</h2>
        <video id="local" autoplay playsinline muted class="w-full max-w-2xl bg-black border border-gray-300 rounded-md"></video>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Log</h2>
        <pre id="log" class="bg-gray-50 border border-gray-200 rounded-md p-4 h-40 overflow-auto text-sm text-gray-800 font-mono"></pre>
      </div>
    </div>

    <script>
      const logEl = document.getElementById("log");
      const localVideo = document.getElementById("local");
      const roomId = 4321;
      let rtpHost = "capture";
      let rtpPort = 5006;
      let rtpPt = 96;

      let janus = null;
      let videoRoom = null;
      let myId = null;
      let localStream = null;
      let forwardStarted = false;
      let forwardAttempts = 0;
      let mdnsDetected = false;
      let mdnsWarningShown = false;

      function log(msg) {
        logEl.textContent += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
      }

      function maybeWarnMdns(candidate) {
        if (!candidate || mdnsWarningShown) {
          return;
        }
        if (candidate.indexOf(".local") === -1 && candidate.toLowerCase().indexOf("mdns") === -1) {
          return;
        }
        mdnsDetected = true;
        mdnsWarningShown = true;
        log("WARNING: Detected mDNS ICE candidates (.local). Janus can't resolve them.");
        log("TIP: Use Firefox or launch Chrome with --disable-features=WebRtcHideLocalIpsWithMdns");
        log("See TROUBLESHOOTING.md for details.");
      }

      function attachIceCandidateLogger() {
        if (!videoRoom || !videoRoom.webrtcStuff || !videoRoom.webrtcStuff.pc) {
          return;
        }
        const pc = videoRoom.webrtcStuff.pc;
        if (pc.__mdnsListenerAttached) {
          return;
        }
        pc.__mdnsListenerAttached = true;
        pc.addEventListener("icecandidate", (event) => {
          if (event.candidate && event.candidate.candidate) {
            maybeWarnMdns(event.candidate.candidate);
          }
        });
      }

      function initJanus() {
        return new Promise((resolve) => {
          Janus.init({
            debug: "all",
            callback: resolve
          });
        });
      }

      function createJanus() {
        return new Promise((resolve, reject) => {
          janus = new Janus({
            server: "ws://localhost:8188/janus",
            iceServers: [],
            success: resolve,
            error: reject,
            destroyed: () => log("Janus destroyed")
          });
        });
      }

      function attachVideoRoom() {
        return new Promise((resolve, reject) => {
          janus.attach({
            plugin: "janus.plugin.videoroom",
            success: (pluginHandle) => {
              videoRoom = pluginHandle;
              resolve();
            },
            error: reject,
            iceState: (state) => {
              log("ICE state: " + state);
              if (state === "failed" || state === "disconnected") {
                log("ERROR: ICE " + state + " - connection lost!");
              }
            },
            webrtcState: (isConnected) => {
              log("WebRTC " + (isConnected ? "connected" : "disconnected"));
              if (!isConnected) {
                log("ERROR: WebRTC disconnected - investigating why...");
                if (mdnsDetected) {
                  log("Likely mDNS ICE failure. See TROUBLESHOOTING.md for fix.");
                }
              }
            },
            mediaState: (medium, receiving, mid) => {
              log("Media state: " + medium + " - receiving: " + receiving);
            },
            slowLink: (uplink, lost, mid) => {
              log("WARNING: Slow link detected! uplink=" + uplink + ", lost=" + lost);
            },
            onmessage: (msg, jsep) => {
              if (msg.videoroom === "joined") {
                myId = msg.id;
                log("Joined room as publisher id " + myId);
              }
              if (msg.videoroom === "event" && msg.configured === "ok") {
                log("Publisher configured");
                // Wait 1 second for media to flow before forwarding
                setTimeout(startRtpForward, 1000);
              }
              if (jsep) {
                videoRoom.handleRemoteJsep({ jsep });
              }
            }
          });
        });
      }

      function ensureRoom() {
        return new Promise((resolve) => {
          videoRoom.send({
            message: {
              request: "create",
              room: roomId,
              publishers: 1,
              videocodec: "vp8",
              secret: "capturesecret"
            },
            success: () => resolve(),
            error: () => resolve()
          });
        });
      }

      function joinRoom() {
        videoRoom.send({
          message: {
            request: "join",
            room: roomId,
            ptype: "publisher",
            display: "browser"
          }
        });
      }

      async function publishStream(stream) {
        localStream = stream;
        localVideo.srcObject = stream;

        const videoTrack = stream.getVideoTracks()[0] || null;
        if (!videoTrack || videoTrack.readyState !== "live" || !stream.active) {
          const state = videoTrack ? videoTrack.readyState : "missing";
          log("ERROR: Video track is not live (state: " + state + "). Check camera permissions or other apps.");
          stopAll();
          return;
        }

        // Monitor track state
        stream.getTracks().forEach((track) => {
          log("Track added: " + track.kind + " - " + track.label + " (state: " + track.readyState + ")");
          track.addEventListener("ended", () => {
            log("WARNING: Track ended unexpectedly!");
          });
          track.addEventListener("mute", () => {
            log("WARNING: Track muted!");
          });
        });

        videoRoom.createOffer({
          stream: stream,
          media: { audioSend: false, videoSend: true, audioRecv: false, videoRecv: false },
          customizeSdp: (jsep) => {
            // Force relay candidates to avoid mDNS issues
            Janus.debug("Original SDP:", jsep.sdp);
          },
          success: (jsep) => {
            attachIceCandidateLogger();
            videoRoom.send({
              message: { request: "configure", audio: false, video: true },
              jsep: jsep
            });
          },
          error: (err) => log("WebRTC error: " + err)
        });
      }

      function startRtpForward() {
        if (!myId || forwardStarted) {
          return;
        }
        forwardAttempts += 1;
        videoRoom.send({
          message: {
            request: "rtp_forward",
            room: roomId,
            publisher_id: myId,
            secret: "capturesecret",
            host: rtpHost,
            video_port: rtpPort,
            video_pt: rtpPt
          },
          success: (result) => {
            if (result && result.error) {
              log("RTP forward error: " + JSON.stringify(result));
              retryForward();
              return;
            }
            forwardStarted = true;
            log("RTP forward ok: " + JSON.stringify(result));
          },
          error: (err) => {
            log("RTP forward error: " + JSON.stringify(err));
            retryForward();
          }
        });
      }

      function retryForward() {
        if (forwardStarted || forwardAttempts >= 5) {
          return;
        }
        setTimeout(startRtpForward, 1000);
      }

      async function start(mode) {
        // Prevent multiple concurrent starts
        if (janus !== null) {
          log("Already connected, please stop first");
          return;
        }

        rtpHost = document.getElementById("rtpHost").value.trim() || rtpHost;
        rtpPort = Number(document.getElementById("rtpPort").value) || rtpPort;
        rtpPt = Number(document.getElementById("rtpPt").value) || rtpPt;

        document.getElementById("webcam").disabled = true;
        document.getElementById("screen").disabled = true;

        try {
          await initJanus();
          await createJanus();
          await attachVideoRoom();
          await ensureRoom();
          joinRoom();

          let stream;
          if (mode === "screen") {
            stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
          } else {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          }
          await publishStream(stream);
          log("Stream published successfully, keeping connection alive...");
        } catch (err) {
          log("Error during start: " + err);
          stopAll();
        }
      }

      function stopAll() {
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
          localStream = null;
        }
        if (videoRoom) {
          videoRoom.hangup();
          videoRoom.detach();
          videoRoom = null;
        }
        if (janus) {
          janus.destroy();
          janus = null;
        }
        forwardStarted = false;
        forwardAttempts = 0;
        document.getElementById("webcam").disabled = false;
        document.getElementById("screen").disabled = false;
      }

      document.getElementById("webcam").addEventListener("click", () => start("webcam"));
      document.getElementById("screen").addEventListener("click", () => start("screen"));
      document.getElementById("stop").addEventListener("click", stopAll);
    </script>
  </body>
</html>
